# Brightmoon (Go 実装)

**東方 Project のアーカイブファイルを操作するための Go 製ツールおよびライブラリ**

## 概要

Brightmoon は、東方Project のゲームで使用されている様々なアーカイブファイル（`.dat` ファイルなど）を扱うためのコマンドラインツールです。
ファイルのリスト表示、抽出（全ファイルまたは特定ファイル）、アーカイブ形式の自動検出と手動指定、並列処理による高速化などの機能を提供します。
オリジナルの C++ 実装から Go へ移植したものです。

## 主な特徴

*   **多彩なアーカイブ形式に対応:**
    *   Hinanawi (紅魔郷 TH06)
    *   Yukari (妖々夢 TH07 - PBG4形式)
    *   Kaguya (永夜抄 TH08, 花映塚 TH09, 弾幕アマノジャク TH143)
    *   Marisa (文花帖 TH095)
    *   Kanako (風神録 TH10 ～ 錦上京 TH20)
    *   Suica (風神録の別形式)
*   **コマンドラインツール:**
    *   アーカイブ内のファイル一覧表示 (`-l`)
    *   アーカイブからのファイル抽出 (`-x` またはファイル名を指定)
    *   出力ディレクトリ指定 (`-o`)
    *   アーカイブ形式の自動検出と手動指定 (`-t`)
    *   並列処理による高速抽出 (`-p`, `-w`)
    *   デバッグ情報表示 (`-d`)
    *   曲目ファイル作るくん (`titles_th` コマンド)
*   **(ライブラリとしての利用も可能ですが、現在はコマンドラインツールとしての利用が主です)**

## インストール

### コマンドラインツール

```bash
go install github.com/shiroemons/go-brightmoon/cmd/brightmoon@latest
go install github.com/shiroemons/go-brightmoon/cmd/titles_th@latest
```

### ソースからビルド

```bash
git clone https://github.com/shiroemons/go-brightmoon
cd go-brightmoon
go build -o brightmoon ./cmd/brightmoon
go build -o titles_th ./cmd/titles_th
```

## 基本的な使い方 (コマンドライン)

### brightmoon: アーカイブ操作ツール

#### コマンド形式

```
brightmoon [オプション] <アーカイブファイル> [抽出ファイル1] [抽出ファイル2] ...
```

*   アーカイブファイル名の後に抽出したいファイル名を指定すると、それらのファイルのみが抽出されます。この場合、`-x` オプションは不要です。
*   抽出ファイルを指定せず、アーカイブ内の**すべてのファイル**を抽出したい場合は `-x` オプションが必要です。

#### オプション

| オプション        | 説明                                                                                                                                  | デフォルト値 |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------|------------|
| `-l`            | アーカイブ内のファイル一覧を表示します。                                                                                                        | `false`    |
| `-x`            | アーカイブから**すべてのファイル**を抽出します。抽出ファイルを指定する場合は不要です。                                                                       | `false`    |
| `-o <dir>`      | 抽出先のディレクトリを指定します。                                                                                                        | `.`        |
| `-t <type>`     | アーカイブタイプを指定します (詳細は後述)。省略すると自動検出を試みます（ユーザープロンプトなし）。                                                                  | `-1`       |
| `-p`            | 並列処理を使用して抽出を高速化します。                                                                                                   | `false`    |
| `-w <num>`      | 並列処理のワーカー数を指定します (`-p` 使用時)。                                                                                             | `4`        |
| `-d`            | デバッグモードを有効にし、詳細な情報を表示します。                                                                                             | `false`    |
| `-v`            | バージョン情報を表示します。                                                                                                               | `false`    |

#### 使用例

**ファイル一覧を表示 (自動検出)**
```bash
brightmoon -l th10.dat
```

**ファイル一覧を表示 (Kanako タイプ 2: 神霊廟以降 を明示的に指定)**
```bash
brightmoon -l -t 2 th13.dat
```

**すべてのファイルを抽出 (自動検出、出力先: `extracted` ディレクトリ)**
```bash
brightmoon -x -o extracted th08.dat
```

**特定のファイルのみを抽出 (ファイル名で指定)**
```bash
brightmoon -o extracted th08.dat bgm/th08_01.wav
```

**並列処理でファイルを高速抽出 (タイプ 1: 弾幕アマノジャク を明示指定、ワーカー数 8)**
```bash
brightmoon -x -t 1 -p -w 8 -o extracted th085.dat
```

**デバッグモードでファイル情報を確認 (自動検出)**
```bash
brightmoon -d -l th07.dat
```

**バージョン情報を表示**
```bash
brightmoon -v
```

### titles_th: 曲目ファイル作るくん

#### コマンド形式

```
titles_th [オプション]
```

#### オプション

| オプション           | 説明                                                                                    | デフォルト値 |
|--------------------|-----------------------------------------------------------------------------------------|------------|
| `--archive`, `-a`   | .datアーカイブファイルのパスを指定します (例: th08.dat)。省略時は自動検出を試みます。                | `""`       |
| `-t <type>`        | アーカイブタイプを指定します (後述の表を参照)。省略時は自動検出を試みます。                          | `-1`       |
| `-o <dir>`         | 生成ファイルの出力先ディレクトリを指定します。                                                   | `.`        |
| `--debug`, `-d`     | デバッグモードを有効にし、詳細な情報を表示します。                                                | `false`    |
| `--dry-run`, `-n`   | ドライラン（ファイルを生成せずに動作確認）。                                                    | `false`    |
| `--version`, `-v`   | バージョン情報を表示します。                                                                | `false`    |

#### 使用例

**thbgm.fmt と musiccmt.txt からタイトル情報を抽出 (カレントディレクトリのファイルを使用)**
```bash
titles_th
```

**アーカイブから直接タイトル情報を抽出 (自動検出)**
```bash
titles_th -a th19.dat
```

**アーカイブから直接タイトル情報を抽出 (タイプを明示指定し、出力先を変更)**
```bash
titles_th -a th10.dat -t 0 -o output
```

**デバッグ情報を表示しながらタイトル情報を抽出**
```bash
titles_th -a th18.dat -d
```

**ドライランで動作確認（ファイル生成なし）**
```bash
titles_th -a th10.dat --dry-run
```

**バージョン情報を表示**
```bash
titles_th -v
```

> **Note:** ダブルクリックで実行する方法については [README.titles_th.md](README.titles_th.md) を参照してください。

### アーカイブ形式の自動判別について (`-t` 未指定時)

`-t` オプションが指定されない場合、Brightmoon は**ユーザーに確認することなく**、以下の手順でアーカイブ形式を自動的に判別しようとします。

1.  定義された順序（Yukari, Yumemi, Suica, Hinanawi, Marisa, Kaguya, Kanako）で各形式でのオープンを試みます。
2.  正常にオープンでき、かつファイルが含まれている（`EnumFirst()` が成功する）形式を候補としてリストアップします。
3.  候補が 1 つだけの場合、その形式として処理を進めます。形式が Kaguya または Kanako の場合はステップ 5 に進みます。
4.  候補が複数見つかった場合、入力された`<アーカイブファイル>`の**ファイル名から形式を推測**します（例: `th08*.dat` なら Kaguya）。
    *   推測が成功し、かつ推測された形式が候補リストに含まれている場合、その形式を選択して処理を進めます。形式が Kaguya または Kanako の場合はステップ 5 に進みます。
    *   ファイル名からの推測に失敗した場合、または推測された形式が候補リストにない場合は、**エラーとなり処理を停止**します。この場合は `-t` オプションで形式を明示的に指定する必要があります。
5.  選択された形式が **Kaguya** または **Kanako** の場合、ファイル名に基づいてさらに**サブタイプを自動的に判別**します（例: `th08*.dat` なら Kaguya タイプ 0、`th13*.dat` なら Kanako タイプ 2）。
    *   ファイル名からサブタイプの判別に失敗した場合は、**エラーとなり処理を停止**します。この場合は `-t` オプションでタイプ（サブタイプを含む）を明示的に指定する必要があります。

**要約:** 自動判別はファイル名に基づいて行われ、曖昧さが解決できない場合やサブタイプの特定が必要な場合に自動判別できない場合はエラーとなります。**ユーザーへの選択プロンプトは表示されません。** 不明瞭な場合は `-t` オプションを使用してください。

**`-t` オプションの値:**

*   **Kaguya アーカイブ:**
    *   `0`: 東方永夜抄 (TH08)
    *   `1`: 弾幕アマノジャク (TH143)
    *   `2`: 東方花映塚 (TH09)
*   **Marisa アーカイブ:**
    *   タイプ指定不要（東方文花帖 TH095 専用）
*   **Kanako アーカイブ:**
    *   `0`: 東方風神録 (TH10) / 東方地霊殿 (TH11)
    *   `1`: 東方星蓮船 (TH12) / ダブルスポイラー (TH125) / 妖精大戦争 (TH128)
    *   `2`: 東方神霊廟 (TH13) 以降の全作品

## 対応ゲーム・ファイル形式

| ゲーム (略称) | ファイル例 | アーカイブ形式 | タイプ指定 (`-t`) | 備考 |
|---|---|---|---|---|
| 東方紅魔郷 (TH06) | `th06*.dat` | Hinanawi | - | 自動検出可能 |
| 東方妖々夢 (TH07) | `th07*.dat` | Yukari | - | 自動検出可能 |
| 東方永夜抄 (TH08) | `th08*.dat` | Kaguya | `0` | 自動検出可能 (ファイル名による) |
| 東方花映塚 (TH09) | `th09*.dat` | Kaguya | `2` | 自動検出可能 (ファイル名による) |
| 東方文花帖 (TH09.5) | `th095*.dat` | Marisa | - | 自動検出可能 |
| 弾幕アマノジャク (TH14.3) | `th143*.dat` | Kaguya | `1` | 自動検出可能 (ファイル名による) |
| 東方風神録 (TH10) | `th10*.dat` | Kanako | `0` | 自動検出可能 (ファイル名による) |
| 東方地霊殿 (TH11) | `th11*.dat` | Kanako | `0` | 自動検出可能 (ファイル名による) |
| 東方星蓮船 (TH12) | `th12*.dat` | Kanako | `1` | 自動検出可能 (ファイル名による) |
| ダブルスポイラー (TH12.5) | `th125*.dat` | Kanako | `1` | 自動検出可能 (ファイル名による) |
| 妖精大戦争 (TH12.8) | `th128*.dat` | Kanako | `1` | 自動検出可能 (ファイル名による) |
| 東方神霊廟 (TH13) | `th13*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方輝針城 (TH14) | `th14*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方紺珠伝 (TH15) | `th15*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方天空璋 (TH16) | `th16*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 秘封ナイトメアダイアリー (TH16.5) | `th165*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方鬼形獣 (TH17) | `th17*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方虹龍洞 (TH18) | `th18*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| バレットフィリア達の闘市場 (TH18.5) | `th185*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方獣王園 (TH19) | `th19*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |
| 東方錦上京 (TH20) | `th20*.dat` | Kanako | `2` | 自動検出可能 (ファイル名による) |

## titles_th 動作確認済みゲーム

以下のゲームで動作確認を行っています。記載されていない最新版でも、アーカイブ形式の仕様が変わっていなければ使用できます。

| ゲーム (略称) | 確認 |
|---|---|
| 東方妖々夢 (TH07) | ✅ |
| 東方永夜抄 (TH08) | ✅ |
| 東方花映塚 (TH09) | ✅ |
| 東方文花帖 (TH09.5) | ✅ |
| 東方風神録 (TH10) | ✅ |
| 東方地霊殿 (TH11) | ✅ |
| 東方星蓮船 (TH12) | ✅ |
| ダブルスポイラー (TH12.5) | ✅ |
| 妖精大戦争 (TH12.8) | ✅ |
| 東方神霊廟 (TH13) | ✅ |
| 東方輝針城 (TH14) | ✅ |
| 弾幕アマノジャク (TH14.3) | ✅ |
| 東方紺珠伝 (TH15) | ✅ |
| 東方天空璋 (TH16) | ✅ |
| 秘封ナイトメアダイアリー (TH16.5) | ✅ |
| 東方鬼形獣 (TH17) | ✅ |
| 東方虹龍洞 (TH18) | ✅ |
| バレットフィリア達の闘市場 (TH18.5) | ✅ |
| 東方獣王園 (TH19) | ✅ |
| 東方錦上京 (TH20) | ✅ |

## アーキテクチャ

### ディレクトリ構造

```
go-brightmoon/
├── cmd/                    # CLIエントリーポイント
│   ├── brightmoon/         # アーカイブ操作ツール
│   └── titles_th/          # 曲目情報抽出ツール
├── pkg/                    # 公開ライブラリ
│   ├── pbgarc/             # アーカイブ形式の実装
│   └── crypto/             # 暗号化・圧縮・デコード処理
└── internal/titles/        # titles_th の内部実装
    ├── app/                # アプリケーションロジック
    ├── archive/            # アーカイブ操作
    ├── parser/             # thbgm.fmt, musiccmt.txt パーサー
    ├── config/             # 設定管理
    ├── fileutil/           # ファイルシステム操作
    └── interfaces/         # インターフェース定義
```

### PBGArchive インターフェース

各アーカイブ形式は共通の `PBGArchive` インターフェースを実装しています:

- `Open()` / `Close()` - アーカイブの開閉
- `EnumFirst()` / `EnumNext()` - エントリの列挙
- `GetEntryName()` - エントリ名取得
- `Extract()` - ファイル抽出

## 開発

### ビルド

```bash
go build -o brightmoon ./cmd/brightmoon
go build -o titles_th ./cmd/titles_th
```

### テスト

```bash
go test ./...
```

### リント

```bash
make lint
```
